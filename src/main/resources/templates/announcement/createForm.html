<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增公告</title>
    <!-- 引入 Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" defer></script>
    <!-- 引入 Quill.js 的樣式與腳本 -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">新增公告</h1>
        <form th:action="@{/announcements/save-announcement}" method="POST">
            <!-- 標題 -->
            <div class="form-group mb-3">
                <label for="title" class="form-label">標題:</label>
                <input type="text" th:field="*{announcement.title}" class="form-control" placeholder="請輸入標題" maxlength="25" required>
            </div>

            <!-- 發布日期 -->
            <div class="form-group mb-3">
                <label for="publishDate" class="form-label">發布日期:</label>
                <input type="date" th:field="*{announcement.publishDate}" class="form-control" required>
            </div>

            <!-- 截止日期 -->
            <div class="form-group mb-3">
                <label for="endDate" class="form-label">截止日期:</label>
                <input type="date" th:field="*{announcement.endDate}" class="form-control" required>
            </div>

            <!-- 發布人 -->
            <div class="form-group mb-3">
                <label for="publisher" class="form-label">發布者:</label>
                <input type="text" th:field="*{announcement.createdBy}" class="form-control" placeholder="請輸入發布人" maxlength="15" required>
            </div>

            <!-- 公告內容 -->
            <div class="form-group mb-3">
                <label for="content" class="form-label">公布內容:</label>
                <div class="col-sm-10">
                    <!-- Quill.js 編輯器容器 -->
                    <div id="quill-editor" style="height: 200px; border: 1px solid #ced4da;"></div>
                    <!-- 隱藏的 textarea -->
                    <textarea id="content" name="content" th:field="*{announcement.content}" class="form-control d-none"></textarea>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">保存</button>
                <a th:href="@{/announcements}" class="btn btn-secondary" id="backToList">返回列表</a>
            </div>
        </form>
    </div>

	<script>
		// 從 textarea 獲取內容並設置到 Quill 編輯器
	    const hiddenContent = document.getElementById('content').value;
	    const quill = new Quill('#quill-editor', {
	        theme: 'snow',
	        modules: {
	            toolbar: [
	                [{ 'header': [1, 2, 3, false] }], // 標題等級
	                ['bold', 'italic', 'underline', 'strike'], // 粗體、斜體、底線、刪除線
	                [{ 'list': 'ordered' }, { 'list': 'bullet' }], // 列表
	                ['link', 'image'], // 插入超連結與圖片
	                ['clean'] // 清除格式
	            ]
	        }
	    });
	    quill.root.innerHTML = hiddenContent; // 將內容設置到 Quill 編輯器
	
	 	// 限制圖片上傳的格式和大小
	    quill.getModule('toolbar').addHandler('image', function () {
	        const input = document.createElement('input');
	        input.setAttribute('type', 'file');
	        input.setAttribute('accept', 'image/jpeg'); // 僅接受 JPG 格式
	        input.click();
	
	        input.onchange = function () {
	            const file = input.files[0];
	            if (file) {
	                if (file.type !== 'image/jpeg') {
	                    alert('只允許上傳 JPG 格式的圖片！');
	                    return;
	                }
	
	                if (file.size > 1 * 1024 * 1024) { // 限制大小為 1MB
	                    alert('圖片大小不能超過 1MB！');
	                    return;
	                }
	
	                const reader = new FileReader();
	                reader.onload = function (e) {
	                    const base64Image = e.target.result;
	                    const range = quill.getSelection();
	                    quill.insertEmbed(range.index, 'image', base64Image);
	                };
	                reader.readAsDataURL(file);
	            }
	        };
	    });
	
	
	    
	 	// 同步 Quill 編輯器內容到 textarea，並限制文字字數
	    quill.on('text-change', function () {
	        const textOnly = quill.getText().trim(); // 獲取純文字內容
	        const maxLength = 100;
	
	        if (textOnly.length > maxLength) {
	            const text = textOnly.substring(0, maxLength); // 截取前 100 字
	            quill.root.innerHTML = text; // 更新 Quill 編輯器內容
	            alert('文字內容不能超過 100 字！');
	        }
	
	        document.getElementById('content').value = quill.root.innerHTML.trim();
	    });


     	// 確認返回列表按鈕的行為
        document.getElementById('backToList').addEventListener('click', function (event) {
            const userConfirmed = confirm('確定返回列表嗎? 您的新增將無法保存');
            if (!userConfirmed) {
                event.preventDefault(); // 如果選擇取消，阻止跳轉
            }
        });
    </script>
</body>
</html>