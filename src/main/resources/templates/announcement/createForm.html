<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增公告</title>
    <!-- 引入 Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" defer></script>
    <!-- 引入 Quill.js 的樣式與腳本 -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">新增公告</h1>
        <form th:action="@{/announcements/save-announcement}" method="POST">
            <!-- 標題 -->
            <div class="form-group mb-3">
                <label for="title" class="form-label">標題:</label>
                <input type="text" th:field="*{announcement.title}" class="form-control" placeholder="請輸入標題" maxlength="25" required>
            </div>

            <!-- 發布日期 -->
            <div class="form-group mb-3">
                <label for="publishDate" class="form-label">發布日期:</label>
                <input type="date" th:field="*{announcement.publishDate}" class="form-control" required>
            </div>

            <!-- 截止日期 -->
            <div class="form-group mb-3">
                <label for="endDate" class="form-label">截止日期:</label>
                <input type="date" th:field="*{announcement.endDate}" class="form-control" required>
            </div>

            <!-- 發布人 -->
            <div class="form-group mb-3">
                <label for="publisher" class="form-label">發布者:</label>
                <input type="text" th:field="*{announcement.createdBy}" class="form-control" placeholder="請輸入發布人" maxlength="15" required>
            </div>

            <!-- 公告內容 -->
            <div class="form-group mb-3">
                <label for="content" class="form-label">公布內容:</label>
                <div class="col-sm-10">
                    <!-- Quill.js 編輯器容器 -->
                    <div id="quill-editor" style="height: 200px; border: 1px solid #ced4da;"></div>
                    <!-- 隱藏的 textarea -->
                    <textarea id="content" name="content" th:field="*{announcement.content}" class="form-control d-none"></textarea>
                    <!-- 限制提示 -->
                    <small id="contentCounter" class="form-text text-muted">還可以輸入 100 字。</small>
                    <small id="imageSizeCounter" class="form-text text-muted">單張圖片不得超過 2 MB，總大小不得超過 5 MB。</small>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">保存</button>
                <a th:href="@{/announcements}" class="btn btn-secondary">返回列表</a>
            </div>
        </form>
    </div>

	<script>
        // 初始化 Quill 編輯器
        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }], // 標題等級
                    ['bold', 'italic', 'underline', 'strike'], // 粗體、斜體、底線、刪除線
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }], // 列表
                    ['link', 'image'], // 插入超連結與圖片
                    ['clean'] // 清除格式
                ]
            }
        });

        const textarea = document.getElementById('content'); // 隱藏的 textarea
        const contentCounter = document.getElementById('contentCounter'); // 字數提示
        const imageSizeCounter = document.getElementById('imageSizeCounter'); // 圖片大小提示
        const maxWords = 100; // 最大字數
        const maxImageSize = 2 * 1024 * 1024; // 單張圖片大小限制 (2 MB)
        const maxTotalImageSize = 5 * 1024 * 1024; // 總圖片大小限制 (5 MB)
        let totalImageSize = 0; // 紀錄所有圖片的總大小

        // 計算字數
        function countWords(text) {
            return text.trim().replace(/<[^>]*>/g, '').length; // 去掉 HTML 標籤後計算字數
        }

        // 更新字數提示
        function updateWordCount() {
            const editorContent = quill.root.innerHTML.trim();
            const wordCount = countWords(editorContent);

            if (wordCount > maxWords) {
                contentCounter.textContent = `已超出 ${wordCount - maxWords} 字，請減少內容！`;
                contentCounter.style.color = 'red';
            } else {
                contentCounter.textContent = `還可以輸入 ${maxWords - wordCount} 字。`;
                contentCounter.style.color = 'black';
            }
        }

        // 更新圖片大小計數器
        function updateTotalImageSize() {
            const images = quill.root.querySelectorAll('img');
            totalImageSize = 0;

            images.forEach(img => {
                if (img.src.startsWith('data:image')) {
                    const base64String = img.src.split(',')[1];
                    const base64Length = base64String.length;
                    totalImageSize += (base64Length * 3) / 4; // Base64 資料大小計算
                }
            });

            if (totalImageSize > maxTotalImageSize) {
                imageSizeCounter.textContent = `圖片總大小已超出 ${((totalImageSize - maxTotalImageSize) / 1024 / 1024).toFixed(2)} MB！請減少圖片大小。`;
                imageSizeCounter.style.color = 'red';
            } else {
                imageSizeCounter.textContent = `單張圖片不得超過 2 MB，總大小不得超過 5 MB。`;
                imageSizeCounter.style.color = 'black';
            }
        }

        // 插入圖片處理
        quill.getModule('toolbar').addHandler('image', function () {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = function () {
                const file = input.files[0];
                if (file) {
                    if (file.size > maxImageSize) {
                        alert('單張圖片大小不能超過 2MB！');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const range = quill.getSelection();
                        quill.insertEmbed(range.index, 'image', e.target.result);
                        updateTotalImageSize();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        });

        // 同步 Quill 編輯器內容到 textarea
        quill.on('text-change', function () {
            textarea.value = quill.root.innerHTML.trim();
            updateWordCount();
            updateTotalImageSize();
        });

        // 表單提交時驗證
        document.querySelector('form').addEventListener('submit', function (event) {
            const editorContent = quill.root.innerHTML.trim();
            const wordCount = countWords(editorContent);

            if (wordCount > maxWords) {
                event.preventDefault();
                alert('公告內容已超出最大字數限制，請減少內容後重新提交！');
                return;
            }

            if (totalImageSize > maxTotalImageSize) {
                event.preventDefault();
                alert('圖片總大小已超出 5 MB 限制，請減少圖片後重新提交！');
                return;
            }
        });

        // 初始化字數和圖片大小
        updateWordCount();
        updateTotalImageSize();
    </script>
</body>
</html>